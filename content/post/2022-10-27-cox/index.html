---
title: sruvial生存分析包参考资料（一）
author: Luo Fei
date: '2022-10-27'
slug: []
categories:
  - Tec
tags:
  - R
math: true
showToc: true
TocOpen: false
toc-title: "目录"
draft: false
hidemeta: false
comments: false
description: "sruvial生存分析包"
canonicalURL: ""
disableShare: false
hideSummary: false
searchHidden: false
ShowReadingTime: false
ShowBreadCrumbs: true
ShowPostNavLinks: true
cover:
    image: "" # image path/url
    alt: "<alt text>" # alt text
    caption: "<text>" # display caption under cover
    relative: false # when using page bundles set this to true
    hidden: true # only hide on current single page      
---



<pre class="r"><code>library(tidyverse)
library(survival)
library(survminer)
library(gtsummary)
theme_gtsummary_journal(&quot;lancet&quot;)
theme_gtsummary_language(&quot;zh-cn&quot;)</code></pre>
<p>关于survial包做生存分析的记录</p>
<div id="基础知识" class="section level1">
<h1>基础知识</h1>
<div id="生存分析" class="section level2">
<h2>生存分析</h2>
<p>生存分析（survival analysis）是生物医学研究中常用的分析方法。在队列随访研究中，我们会事先定义一些观察终点，比如肿瘤复发、患者死亡、血压达标等，这些终点称为事件（event）。从研究开始到发生事件的时间间隔称为生存时间（survival time），某些场景下也称为失效时间（failure time）。由于生存时间数据具有以下两个特点，所以提出生存分析这一特殊的分析方法：
（1）偏态分布：生存时间通常具有明显的偏态分布，有正态分布假设的统计方法不能适用。
（2）删失（censoring）：研究对象在观察时间内没有发生事件称为删失。一种情况是研究对象在中途失访或退出，导致没有观察到事件；另一种情况是超过了最长的随访时间事件仍未发生。删失数据是一种不完整数据，是生成分析独有的重要组成部分。</p>
</div>
<div id="包里的常用函数" class="section level2">
<h2>包里的常用函数</h2>
<ul>
<li><p><strong>Surv()</strong> 函数主要用于对时间和状态变量进行转换，主要作为模型的自变量，放在模型方程左边，例如：</p>
<ul>
<li><p><code>Surv(time, status )</code> 右截断数据（right censored data）在进行随访观察中，研究对象观察的起始时间已知，但终点事件发生的时间未知，无法获取具体的生存时间，只知道生存时间大于观察时间，这种类型的生存时间称为右删失。</p></li>
<li><p><code>Surv(time, endpoint=='death')</code> 状态变量是因子或字符的时候</p></li>
<li><p><code>Surv(t1, t2, status)</code> 连续的过程变量</p></li>
<li><p><code>Surv(t1, ind, type='left')</code> 左删失</p></li>
</ul>
<blockquote>
<p>左删失（Left censored）假设研究对象在某一时刻开始进入研究接受观察，但是在该时间点之前，研究所感兴趣的时间点已经发生，但无法明确具体时间，这种类型即为左删失数据。例如，某项关于脑卒中复发危险因素的研究，生存时间规定为从第一次脑卒中发病到下一次脑卒中发病之间的时间间隔。在研究起始时刻对研究对象进行问卷调查，询问是否发生过脑卒中，以及第一次脑卒中发病的时间，如果研究对象回答“发生过脑卒中。</p>
</blockquote></li>
<li><p><strong>aareg()</strong> Aalen’s additive regression model.</p></li>
<li><p><strong>coxph()</strong> Cox比例风险模型</p>
<ul>
<li><p><code>coxph(Surv(time, status) ~ x, data=aml)</code> -标准cox模型</p></li>
<li><p><code>coxph(Surv(t1, t2, stat) ~ (age + surgery) * transplant)</code> -时间相关协变量</p></li>
<li><p><code>y &lt;- Surv(t1, t2, stat)</code>
<code>coxph(y ~ strata(inst) * sex + age + treat)</code> -分层模型，每个机构有不同的基线和机构对性别的交互作用。</p></li>
<li><p><code>coxph(y ~  offset(x1) + x2)</code> -设置x1为已经系数项，不估计其系数。</p></li>
</ul></li>
<li><p><strong>cox.zph()</strong> 基于加权残差的cox模型的比例风险检验。</p></li>
</ul>
<pre class="r"><code>fit &lt;- coxph(Surv(futime, fustat) ~ age + ecog.ps, data = ovarian)
temp &lt;- cox.zph(fit)
print(temp) %&gt;%
    knitr::kable()  # display the results </code></pre>
<pre><code>    chisq df    p</code></pre>
<p>age 0.698 1 0.40
ecog.ps 2.371 1 0.12
GLOBAL 3.633 2 0.16</p>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="right">chisq</th>
<th align="right">df</th>
<th align="right">p</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">age</td>
<td align="right">0.698</td>
<td align="right">1</td>
<td align="right">0.404</td>
</tr>
<tr class="even">
<td align="left">ecog.ps</td>
<td align="right">2.371</td>
<td align="right">1</td>
<td align="right">0.124</td>
</tr>
<tr class="odd">
<td align="left">GLOBAL</td>
<td align="right">3.633</td>
<td align="right">2</td>
<td align="right">0.163</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>tcut()</strong> -<code>rcut()</code>-在不丢失连续性特征的情况下分段，如</li>
</ul>
<pre class="r"><code>heart %&gt;%
    select(age) %&gt;%
    mutate(cut = cut(age + 40, c(0, 50, 70)), tcut = tcut(age + 40, c(0, 50, 70))) %&gt;%
    head(10) %&gt;%
    knitr::kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="right">age</th>
<th align="left">cut</th>
<th align="right">tcut</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">-17.16</td>
<td align="left">(0,50]</td>
<td align="right">22.8</td>
</tr>
<tr class="even">
<td align="right">3.84</td>
<td align="left">(0,50]</td>
<td align="right">43.8</td>
</tr>
<tr class="odd">
<td align="right">6.30</td>
<td align="left">(0,50]</td>
<td align="right">46.3</td>
</tr>
<tr class="even">
<td align="right">6.30</td>
<td align="left">(0,50]</td>
<td align="right">46.3</td>
</tr>
<tr class="odd">
<td align="right">-7.74</td>
<td align="left">(0,50]</td>
<td align="right">32.3</td>
</tr>
<tr class="even">
<td align="right">-7.74</td>
<td align="left">(0,50]</td>
<td align="right">32.3</td>
</tr>
<tr class="odd">
<td align="right">-27.21</td>
<td align="left">(0,50]</td>
<td align="right">12.8</td>
</tr>
<tr class="even">
<td align="right">6.59</td>
<td align="left">(0,50]</td>
<td align="right">46.6</td>
</tr>
<tr class="odd">
<td align="right">2.87</td>
<td align="left">(0,50]</td>
<td align="right">42.9</td>
</tr>
<tr class="even">
<td align="right">2.87</td>
<td align="left">(0,50]</td>
<td align="right">42.9</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>pyears()</strong> -个体生存情况分析，比如分别计算<code>heart</code>数据集里面手术组和非手术组各年龄组的死亡率。</li>
</ul>
<pre class="r"><code>fit1 &lt;- pyears(Surv(stop/365.25, event) ~ cut(age + 48, c(0, 50, 60, 70, 100)) +
    surgery, data = heart, scale = 1)
fit1$event/fit1$pyears</code></pre>
<pre><code>#                                     surgery
# cut(age + 48, c(0, 50, 60, 70, 100))     0     1
#                             (0,50]   0.707 0.289
#                             (50,60]  1.778 0.779
#                             (60,70]  4.081   NaN
#                             (70,100]   NaN   NaN</code></pre>
<ul>
<li><strong>survexp()</strong> 计算指定对象的预期生存率</li>
</ul>
<pre class="r"><code># Estimate of conditional survival
fit1 &lt;- survexp(futime ~ 1, rmap = list(sex = &quot;male&quot;, year = accept.dt, age = (accept.dt -
    birth.dt)), method = &quot;conditional&quot;, data = jasa)
summary(fit1, times = 1:10 * 182.5, scale = 365)  #expected survival by 1/2 years</code></pre>
<pre><code># Call: survexp(formula = futime ~ 1, data = jasa, rmap = list(sex = &quot;male&quot;, 
#     year = accept.dt, age = (accept.dt - birth.dt)), method = &quot;conditional&quot;)
# 
#  time n.risk survival
#   0.5     41    0.996
#   1.0     28    0.993
#   1.5     21    0.989
#   2.0     16    0.986
#   2.5     13    0.983
#   3.0      8    0.980
#   3.5      7    0.977
#   4.0      3    0.972
#   4.5      1    0.969</code></pre>
<pre class="r"><code># Estimate of expected survival stratified by prior surgery
survexp(~surgery, rmap = list(sex = &quot;male&quot;, year = accept.dt, age = (accept.dt -
    birth.dt)), method = &quot;ederer&quot;, data = jasa, times = 1:10 * 182.5)</code></pre>
<pre><code># Call:
# survexp(formula = ~surgery, data = jasa, rmap = list(sex = &quot;male&quot;, 
#     year = accept.dt, age = (accept.dt - birth.dt)), times = 1:10 * 
#     182.5, method = &quot;ederer&quot;)
# 
#   age ranges from 8.8 to 64.4 years
#   male: 103  female: 0 
#   date of entry from 1967-09-13 to 1974-03-22 
# 
#  time nrisk1 nrisk2 surgery=0 surgery=1
#   182     87     16     0.996     0.996
#   365     87     16     0.991     0.993
#   548     87     16     0.987     0.989
#   730     87     16     0.982     0.985
#   912     87     16     0.978     0.981
#  1095     87     16     0.973     0.977
#  1278     87     16     0.968     0.973
#  1460     87     16     0.963     0.969
#  1642     87     16     0.958     0.964
#  1825     87     16     0.952     0.960</code></pre>
<pre class="r"><code>## Compare the survival curves for the Mayo PBC data to Cox model fit
pfit &lt;- coxph(Surv(time, status &gt; 0) ~ trt + log(bili) + log(protime) + age + platelet,
    data = pbc)
plot(survfit(Surv(time, status &gt; 0) ~ trt, data = pbc), mark.time = FALSE)
lines(survexp(~trt, ratetable = pfit, data = pbc), col = &quot;purple&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-5-1.png" width="672" style="display: block; margin: auto;" /></p>
<ul>
<li><strong>survdiff()</strong> -使用<span class="math inline">\(G^\rho\)</span>检验，比较两组或多组生存曲线的差异。</li>
</ul>
<pre class="r"><code># US mortality tables
expect &lt;- survexp(futime ~ 1, data = jasa, cohort = FALSE, rmap = list(age = (accept.dt -
    birth.dt), sex = 1, year = accept.dt), ratetable = survexp.us)
## actual survival is much worse (no surprise)
survdiff(Surv(jasa$futime, jasa$fustat) ~ offset(expect))</code></pre>
<pre><code># Call:
# survdiff(formula = Surv(jasa$futime, jasa$fustat) ~ offset(expect))
# 
# Observed Expected        Z        p 
#   75.000    0.644  -92.681    0.000</code></pre>
<ul>
<li><p><strong>survreg()</strong> 参数生存回归模型，即把自变量做对数转换或其他转换</p>
<ul>
<li><code>survreg(Surv(time, stat) ~ x, dist='loglogistic'</code> -拟合log-logistic分布模型</li>
</ul></li>
</ul>
</div>
<div id="数学符号定义" class="section level2">
<h2>数学符号定义</h2>
<ul>
<li><span class="math inline">\(risk set\)</span> 在时间事件分析中，给定的对象只在制定的时间范围内观测，例如，研究1990年到2000年的接受某种治疗方法的患者10年内的生存情况，队列中1990年接受治疗的将有10年的潜在观测期，但1995年后的只有5年的观测期。设<span class="math inline">\(Y_i(t),i=1,...n\)</span>为对象<span class="math inline">\(i\)</span>在<span class="math inline">\(t\)</span>时刻观测到“事件”发生。<span class="math inline">\(Ni(t)\)</span>为<span class="math inline">\(t\)</span>时刻时观测到发生“事件”发生的对象数，“事件”可能多次发生也可能只发生一次。那么到<span class="math inline">\(t\)</span>时刻时发生“事件”的总数为<span class="math inline">\(\overline{N}(t)=\sum{N_i(t)}\)</span>，在<span class="math inline">\(t\)</span>时刻发生“事件”的对象数为<span class="math inline">\(\overline{Y}(t)=\sum{Y_i(t)}\)</span>。对象的事件相关协变量为<span class="math inline">\(X_i(t)\)</span>。<span class="math inline">\(d(t)\)</span>为“事件”在<span class="math inline">\(t\)</span>时刻的瞬时发生率.</li>
</ul>
</div>
</div>
<div id="生存曲线" class="section level1">
<h1>生存曲线</h1>
<div id="单事件" class="section level2">
<h2>单事件</h2>
<p>通常用，<span class="math inline">\(t\)</span>时刻事的事件发生概率的乘积的Kaplan-Meier曲线来描述生存数据。</p>
<p><span class="math display">\[\begin{align}

\hat{S}_{KM}(t)=\prod_{S&lt;t}\frac{\overline{N}(ts)-d(s)}{\overline{Y}(s)}

\end{align}\]</span></p>
</div>
</div>
