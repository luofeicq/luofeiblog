---
title: R社交网络分析包在传染病传播链可视化的应用
author: Luo Fei
date: '2022-03-25'
slug: chainR
categories:
  - Tec
  - 中文
tags:
  - R
  - Tec
output:
    blogdown::html_page:
        number_sections: false 
math: true
showToc: true
TocOpen: false
toc-title: "目录"
draft: false
hidemeta: false
comments: false
description: "跨专业的尝试"
canonicalURL: ""
disableShare: false
hideSummary: false
searchHidden: false
ShowReadingTime: false
ShowBreadCrumbs: true
ShowPostNavLinks: true
cover:
    image: "" # image path/url
    alt: "<alt text>" # alt text
    caption: "<text>" # display caption under cover
    relative: false # when using page bundles set this to true
    hidden: true # only hide on current single page    
---

```{r,setup,include=FALSE}
options(digits = 2)

##knitr设置
knitr::opts_chunk$set(
  prompt = FALSE,
  comment = "#",
  results = "markup",
  error = FALSE,
  message = FALSE,
  fig.align = "center",
  collapse = FALSE,
  tidy = TRUE,
  echo = F,
  message = F,
  results = "hide",
  warning = F
  )

```



```{r}
library(tidyverse)
library(readxl)
library(igraph)
library(networkD3)
library(RColorBrewer)
library(ggraph)
library(tidygraph)
```
## 初衷

在这次疫情处理过程中，了解到在梳理传播链的过程中，很多时候仍然是手工在`powerpoint`等软件绘制传播链的。采用这种方式的优点能够在图中根据设计者需要加入较多的信息，比如：人员大致位置分布，接触的途径和强度等信息。不足之处在于，**在链条上节点（感染者）较少的时候还能够梳理得很明确，但一旦节点达到一定数量，其中关系复杂度将呈几何倍数增加**（比如1人传多个，1人与多个感染者有接触之类）。

在这种情况下。单纯的手工整理，将耗费非常多的脑力。最严重的缺点是，当现场流调信息变更，对链条进行修订的时，其中一个节点或链接的变化，会因连锁作用导致整个链条的变化。节点越多，变化的影响范围越大，越复杂，就像整理线头一样。当感染者人数上升到一定数量时，手动整理已经变成了一件难以完成的事情。由于本人对R的热衷，探索了一下能不能使用软件**自动化链**~~就是自己懒嘛~~的方式绘制传播，使用`igraph`，`ggraph`和`networkD3`最终效果如下面几张图,个人觉得还是`networkD3`炫酷的互动效果最好。


```{r,include=FALSE,results='hide'}

node <- read_xlsx("data/net/node_df.xlsx") # 读取节点数据
line <- read_xlsx("data/net/line_df.xlsx") # 读取边数据
g <- graph_from_data_frame(d =line, vertices = node,  directed = T) #转换为graph对象



## 计算节点的度

deg <- degree(g, mode = "all")

## 设置颜色
  
vcolour <-  palette(brewer.pal(8 , "Set1"))

V(g)$colour <- vcolour[factor(V(g)$group)]

## 指定边的颜色

ecolour <- vcolour[factor(E(g)$value)]

## 按链接进行分组
group <- g %>% cluster_walktrap() %>% membership()

#画图 

plot.igraph(g, 
            vertex.color = vcolour,
            vertex.frame.color = "white",
            vertex.shape = "circle",
            vertex.size = 10,
            vertex.size2 = 15,
            vertex.alpha = 0.3,
            #vertex.label = "name",
            #vertex.label.family = "Times",
            #vertex.label.font = ""，
            vertex.label.dist = 0.2,
            vertex.label.cex = 0.5,
            verex.label.degree = pi/2,
            vertex.label.color = "black",
            edge.color = ecolour,
            edeg.width = 0.8,
            edge.arrow.size = 0.2,
            edge.arrow.width = 0.8,
            edge.lty = 1,
            edge.label.cex = 0.8,
            edge.label.color = 1,
            arrow.mode = 2,
            edge.curved = 0.2,
            loop.angle = 0.2,
            frame = F,
            palette = vcolour,
            asp = 16/9,
            #main = "主标题",
            #sub = "副标题",
            bf = "grey") 

## ggraph

g <- g %>% as_tbl_graph(g)
ggraph(g) + 
geom_edge_fan(color="grey",show.legend=T) + 
geom_node_point(aes(size = size,fill=factor(group)),shape=21)+ 
geom_node_text(aes(filter= deg>2,label=name),size=2.5)+
geom_edge_link(aes(),color="lightblue",
                arrow = arrow(length = unit(2, 'mm')), 
                end_cap = circle(3, 'mm')) +
scale_color_discrete()+
scale_edge_width(range=c(0.2,3))+
guides(size=F,fill=F)+ theme_graph()

```

```{r, results='hide'}
## ggraph

g <- g %>% as_tbl_graph(g)
group <- g %>% cluster_walktrap() %>% membership()

gd3 <- igraph_to_networkD3(g, group = group)

gd3$nodes["size"] <- node$size
forceNetwork(Links = gd3$links, Nodes = gd3$nodes, Source = "source", Target = "target", Value = "value", NodeID = "name", Group = "group", Nodesize = "size", opacity = 2, zoom = T, arrows = T, legend = F, opacityNoHover = 1, bounded = F,fontSize = 12 )

sankeyNetwork(Links = gd3$links, Nodes = gd3$nodes,Source = "source", Target = "target",
              NodeID = "name", Value = "value", fontSize = 16, unit = "Letter(s)", iterations = 20)


```

# 具体制作过程

参见我使用的3个包的说明。。。。。详细步骤待补充。

## 数据

### 节点数据

节点数据里面只需要包含所有感染者的基本信息，比如编号，姓名，类别等等。

### 边数据

边数据最基础的要求为，节点数据左右感染者的对应关系，简单说就像Excel两列，第一列`from`， 第二列`to`，代表每一行两个感染者的关系，从谁传播到谁，当然这些资料需要辛苦在现场的流调专家们提供。


## 可视化

### igraph

首先使用`graph_from_data_frame(d =line, vertices = node,  directed = T)`将节点和边转换成`igraph`，就可以直接`plot`第一张图, 参数自己可以调节。

```{r, fig.width=20,fig.height=16}
node <- read_xlsx("data/net/node_df.xlsx") # 读取节点数据
line <- read_xlsx("data/net/line_df.xlsx") # 读取边数据
g <- graph_from_data_frame(d =line, vertices = node,  directed = T) #转换为graph对象

## 计算节点的度

deg <- degree(g, mode = "all")

## 设置颜色
vcolour <-  palette(brewer.pal(8 , "Set1"))
V(g)$colour <- vcolour[factor(V(g)$group)]
## 指定边的颜色
ecolour <- vcolour[factor(E(g)$value)]
#画图 
plot.igraph(g, 
            vertex.color = vcolour,
            vertex.frame.color = "white",
            vertex.shape = "circle",
            vertex.size = 10,
            vertex.size2 = 15,
            vertex.alpha = 0.3,
            #vertex.label = "name",
            #vertex.label.family = "Times",
            #vertex.label.font = ""，
            vertex.label.dist = 1,
            vertex.label.cex = 1.5,
            verex.label.degree = pi/2,
            vertex.label.color = "black",
            edge.color = ecolour,
            edeg.width = 0.8,
            edge.arrow.size = 0.2,
            edge.arrow.width = 0.8,
            edge.lty = 1,
            edge.label.cex = 0.8,
            edge.label.color = 1,
            arrow.mode = 2,
            edge.curved = 0.2,
            loop.angle = 0.2,
            frame = F,
            palette = vcolour,
            asp = 16/9,
            #main = "主标题",
            #sub = "副标题",
            bf = "grey") 
```


### netwokd3

个人最喜欢的效果，使用`igraph_to_networkD3`命令，将`igraph`数据转换一下，就可以使用`simpleNetwork`,`forceNetwork`，`sankeyNetwork(`画出交互性网络图了。试验了下，手机浏览器一样可以互动，包括拖动节点，放大，移动等，非常棒的体验。

```{r, results='asis'}


gd3$nodes["size"] <- node$size
forceNetwork(Links = gd3$links, Nodes = gd3$nodes, Source = "source", Target = "target", Value = "value", NodeID = "name", Group = "group", Nodesize = "size", opacity = 2, zoom = T, arrows = T, legend = F, opacityNoHover = 1, bounded = F,fontSize = 12 )

sankeyNetwork(Links = gd3$links, Nodes = gd3$nodes,Source = "source", Target = "target",
              NodeID = "name", Value = "value", fontSize = 16, unit = "Letter(s)", iterations = 20)

```

### ggraph

`ggraph`基本研用了`ggplot2`绘图的方式，画出来的图也相对更漂亮。首先使用`tidygraph`包将`igraph`类型的数据转换为`ggraph`更合适的元数据。然后可以愉快地使用`ggplot2`的方式画图了。

```{r, results='asis'}
## ggraph


ggraph(g) + 
geom_edge_fan(color="grey",show.legend=T) + 
geom_node_point(aes(size = size,fill=factor(group)),shape=21)+ 
geom_node_text(aes(filter= deg>2,label=name),size=2.5)+
geom_edge_link(aes(),color="lightblue",
                arrow = arrow(length = unit(2, 'mm')), 
                end_cap = circle(3, 'mm')) +
scale_color_discrete()+
scale_edge_width(range=c(0.2,3))+
guides(size=F,fill=F)+ theme_graph()
```


