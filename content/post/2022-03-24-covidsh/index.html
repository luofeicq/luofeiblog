---
title: R爬上海疫情数据简单可视化分析(4月6日更新)
author: Luo Fei
date: '2022-03-24'
slug: covidsh
categories:
  - 中文
tags:
  - Tec
  - R
output:
    blogdown::html_page:
        number_sections: true
math: true
showToc: true
TocOpen: false
toc-title: "目录"
draft: false
hidemeta: false
comments: false
description: "无责任猜测。"
canonicalURL: ""
disableShare: false
hideSummary: false
searchHidden: false
ShowReadingTime: false
ShowBreadCrumbs: true
ShowPostNavLinks: true
cover:
    image: "" # image path/url
    alt: "<alt text>" # alt text
    caption: "<text>" # display caption under cover
    relative: false # when using page bundles set this to true
    hidden: true # only hide on current single page    
---



<p>今天本地的疫情终于没有增加，抽了点时间关注其他地区的疫情形势。看官方通报的数据，对曾经的模范城市的疫情有兴趣，决定来简单看看。</p>
<div id="数据获取" class="section level1" number="1">
<h1><span class="header-section-number">1</span> 数据获取</h1>
<div id="数据来源" class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> 数据来源</h2>
<p>要获取准确的数据，当然是上官方网站。打开上海市卫健委的官网(<a href="https://wsjkw.sh.gov.cn/xwfb/index.html" class="uri">https://wsjkw.sh.gov.cn/xwfb/index.html</a>)，疫情数据公告都在“新闻发布”栏目中，再仔细一看，疫情信息的标题中就包含了所有新增、确诊数据。真是太方便了。新闻页面也是连续的以<code>_[num]</code>为页码的编号，这种页面爬起来不要太省事。</p>
</div>
<div id="r包" class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> R包</h2>
<p>首先加载需要用到的包，主要使用<code>rvest</code>包获取静态网页信息，谷歌浏览器<code>selectorgadget</code>插件获取需要信息的节点，<code>tidyverse</code>整理数据，绘图，<code>lubridate</code>包处理日期变量。</p>
<pre class="r"><code>library(rvest)
library(tidyverse)
library(lubridate)
library(readxl)
library(openxlsx)
library(ggforce)</code></pre>
</div>
<div id="主页信息获取" class="section level2" number="1.3">
<h2><span class="header-section-number">1.3</span> 主页信息获取</h2>
<p>使用<code>selectorgadget</code>在网页上找到需要的变量“时间”和“标题”，对应的node分别是<code>.time</code>和<code>.list-data a</code>，使用<code>rvest</code>抓取后，转为文本存储在列表中。</p>
<pre class="r"><code>## 设置url
url &lt;- &quot;https://wsjkw.sh.gov.cn/xwfb/index.html&quot;
## 获取首页信息
content &lt;- read_html(url)
reportdate &lt;- content %&gt;%  html_nodes(&quot;.time&quot;) %&gt;% html_text() %&gt;% as.Date.character()
title &lt;-  content %&gt;% html_nodes(&quot;.list-date a&quot;) %&gt;% html_text() 
basedata &lt;- tibble(reportdate = reportdate, title = title)</code></pre>
</div>
<div id="爬取所有数据" class="section level2" number="1.4">
<h2><span class="header-section-number">1.4</span> 爬取所有数据</h2>
<p>上海的疫情变化主要从3月开始，但为了查看之前的变化，是否输入病例压力增大导致本次疫情，因此爬取了2到200页到的数据。改用<code>purrr</code>包的<code>map_df</code>函数爬取。</p>
<pre class="r"><code>##使用循环爬取2到200也网页信息
url_1 &lt;- c(&quot;https://wsjkw.sh.gov.cn/xwfb/index.html&quot;,
           paste0(&quot;https://wsjkw.sh.gov.cn/xwfb/index_&quot;, c(2:200), &quot;.html&quot;))
webfun_0 &lt;- function(url){
    webpage &lt;- read_html(url) 
    tibble( &quot;reportdate&quot; = webpage %&gt;% html_nodes(&quot;.time&quot;) %&gt;% html_text(),
    &quot;title&quot; = webpage %&gt;% html_nodes(&quot;.list-date a&quot;) %&gt;% html_attr(&quot;title&quot;))
  }
basedata &lt;- map_df(url_1, webfun_0) 


## 写出数据
write.csv(basedata,&quot;data/basedata.csv&quot;)</code></pre>
</div>
<div id="数据清洗" class="section level2" number="1.5">
<h2><span class="header-section-number">1.5</span> 数据清洗</h2>
<p>这一步比较麻烦的是对标题中日期字符的整理。使用<code>str_extract_all</code>命令后提取的日期，变成了列表。再合并为向量形势的日期格式数据时出了点麻烦。最后使用了笨办法<code>for</code>循环<code>unlist</code>后再<code>paste0</code>合并。其实直接用标题前的日期-1没什么大的误差，主要是在跟自己较劲搞得这么麻烦。</p>
</div>
</div>
<div id="好了开始分析吧" class="section level1" number="2">
<h1><span class="header-section-number">2</span> 好了，开始分析吧</h1>
<div id="先画个简单的图看看大趋势" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> 先画个简单的图看看大趋势</h2>
<p>以报告感染者类型为颜色看，从20年1月到21年12月期间，上海的感染人数几乎在处于一个长期稳定的状态，从2022年3月开始呈直升飞机式的增长。奇怪的是中间咋有个空白区，没有数据。查看原始网页，发现网站从2021年11月6日-2022年1月1日没有更新数据。这是一个奇怪的现象。不过没关系，这不影响我们后面的分析，<del>这对原因分析有很大关系</del>。</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-5-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="输入感染者的趋势" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> 输入感染者的趋势</h2>
<p>对上海这波疫情有个合理的猜测是，1月初上海接纳大量某地的航班的，导致上海市输入疫情压力陡增，再加上Omicron变异株超强传播能力，双重压力下导致这个模范城市失守。好吧，我们来看看是否能验证输入压力陡增这个猜测。从图上看新增输入的感染者数量变化并不大，鉴于确诊和无症状都属与感染这，下一步我们把本地和输入的感染者的合计数的变化可视化看看。</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-6-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="感染者总数" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> 感染者总数</h2>
<p>先用二者做个散点图看看,如图，完全看不出啥关系啊。。。。输入感染者较多的时候，反而本地感染处于低水平。这个图像，线性回归暂时也不考虑。我们还是从感染者数量和时间的关系看看。</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>画出来如下，大致能看出在3月14日前，上海几乎没有本土感染病例。
<img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-8-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="年1到三月" class="section level2" number="2.4">
<h2><span class="header-section-number">2.4</span> 2022年1到三月</h2>
<p>我们把时间尺度拉大到2月中旬到3月看看。放大后（下图1）到3月14日，输入感染人数开始上升，此时上海本地感染数量仍然无幅度的改变，处于平稳状态。为了更仔细看清楚变化情况，我们将y轴的数量调整至0-1000例，这时候能清楚看到每天的变化，本地感染者（蓝色）数量从3月16日快速上升者。</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-9-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="重点关注3月的数据" class="section level2" number="2.5">
<h2><span class="header-section-number">2.5</span> 重点关注3月的数据</h2>
</div>
<div id="地区分布" class="section level2" number="2.6">
<h2><span class="header-section-number">2.6</span> 地区分布</h2>
<p>重新爬了一下按地区分布的，结果很明显，浦东新区感染者数量最多，见下表：</p>
<table>
<colgroup>
<col width="4%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Local</th>
<th align="right">2022-04-05</th>
<th align="right">2022-04-04</th>
<th align="right">2022-04-03</th>
<th align="right">2022-04-01</th>
<th align="right">2022-03-28</th>
<th align="right">2022-03-31</th>
<th align="right">2022-03-30</th>
<th align="right">2022-03-29</th>
<th align="right">2022-04-02</th>
<th align="right">2022-03-25</th>
<th align="right">2022-03-27</th>
<th align="right">2022-03-26</th>
<th align="right">2022-03-24</th>
<th align="right">2022-03-22</th>
<th align="right">2022-03-20</th>
<th align="right">2022-03-23</th>
<th align="right">2022-03-21</th>
<th align="right">2022-03-19</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">浦东新区</td>
<td align="right">8145</td>
<td align="right">7071</td>
<td align="right">3654</td>
<td align="right">2584</td>
<td align="right">2506</td>
<td align="right">2407</td>
<td align="right">2207</td>
<td align="right">2183</td>
<td align="right">2038</td>
<td align="right">1914</td>
<td align="right">1429</td>
<td align="right">323</td>
<td align="right">193</td>
<td align="right">237</td>
<td align="right">220</td>
<td align="right">218</td>
<td align="right">169</td>
<td align="right">135</td>
</tr>
<tr class="even">
<td align="left">闵行区</td>
<td align="right">2937</td>
<td align="right">1381</td>
<td align="right">940</td>
<td align="right">1043</td>
<td align="right">370</td>
<td align="right">392</td>
<td align="right">780</td>
<td align="right">987</td>
<td align="right">829</td>
<td align="right">206</td>
<td align="right">619</td>
<td align="right">972</td>
<td align="right">490</td>
<td align="right">305</td>
<td align="right">265</td>
<td align="right">256</td>
<td align="right">122</td>
<td align="right">53</td>
</tr>
<tr class="odd">
<td align="left">徐汇区</td>
<td align="right">920</td>
<td align="right">1229</td>
<td align="right">499</td>
<td align="right">639</td>
<td align="right">91</td>
<td align="right">226</td>
<td align="right">404</td>
<td align="right">1100</td>
<td align="right">1042</td>
<td align="right">3</td>
<td align="right">277</td>
<td align="right">331</td>
<td align="right">167</td>
<td align="right">87</td>
<td align="right">46</td>
<td align="right">106</td>
<td align="right">130</td>
<td align="right">61</td>
</tr>
<tr class="even">
<td align="left">黄浦区</td>
<td align="right">658</td>
<td align="right">970</td>
<td align="right">824</td>
<td align="right">260</td>
<td align="right">283</td>
<td align="right">121</td>
<td align="right">361</td>
<td align="right">110</td>
<td align="right">659</td>
<td align="right">23</td>
<td align="right">56</td>
<td align="right">160</td>
<td align="right">102</td>
<td align="right">59</td>
<td align="right">42</td>
<td align="right">20</td>
<td align="right">49</td>
<td align="right">36</td>
</tr>
<tr class="odd">
<td align="left">松江区</td>
<td align="right">796</td>
<td align="right">559</td>
<td align="right">263</td>
<td align="right">493</td>
<td align="right">94</td>
<td align="right">184</td>
<td align="right">246</td>
<td align="right">228</td>
<td align="right">567</td>
<td align="right">15</td>
<td align="right">190</td>
<td align="right">79</td>
<td align="right">92</td>
<td align="right">31</td>
<td align="right">9</td>
<td align="right">34</td>
<td align="right">39</td>
<td align="right">16</td>
</tr>
<tr class="even">
<td align="left">杨浦区</td>
<td align="right">623</td>
<td align="right">220</td>
<td align="right">374</td>
<td align="right">134</td>
<td align="right">47</td>
<td align="right">174</td>
<td align="right">100</td>
<td align="right">99</td>
<td align="right">274</td>
<td align="right">11</td>
<td align="right">35</td>
<td align="right">23</td>
<td align="right">21</td>
<td align="right">3</td>
<td align="right">8</td>
<td align="right">11</td>
<td align="right">10</td>
<td align="right">14</td>
</tr>
<tr class="odd">
<td align="left">嘉定区</td>
<td align="right">481</td>
<td align="right">4</td>
<td align="right">415</td>
<td align="right">200</td>
<td align="right">209</td>
<td align="right">54</td>
<td align="right">158</td>
<td align="right">9</td>
<td align="right">617</td>
<td align="right">19</td>
<td align="right">251</td>
<td align="right">242</td>
<td align="right">130</td>
<td align="right">111</td>
<td align="right">NA</td>
<td align="right">69</td>
<td align="right">NA</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="left">虹口区</td>
<td align="right">410</td>
<td align="right">608</td>
<td align="right">188</td>
<td align="right">61</td>
<td align="right">8</td>
<td align="right">128</td>
<td align="right">84</td>
<td align="right">73</td>
<td align="right">342</td>
<td align="right">4</td>
<td align="right">27</td>
<td align="right">50</td>
<td align="right">29</td>
<td align="right">13</td>
<td align="right">12</td>
<td align="right">26</td>
<td align="right">23</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">宝山区</td>
<td align="right">554</td>
<td align="right">265</td>
<td align="right">467</td>
<td align="right">45</td>
<td align="right">311</td>
<td align="right">17</td>
<td align="right">504</td>
<td align="right">363</td>
<td align="right">485</td>
<td align="right">4</td>
<td align="right">94</td>
<td align="right">153</td>
<td align="right">87</td>
<td align="right">16</td>
<td align="right">13</td>
<td align="right">69</td>
<td align="right">67</td>
<td align="right">17</td>
</tr>
<tr class="even">
<td align="left">普陀区</td>
<td align="right">483</td>
<td align="right">254</td>
<td align="right">321</td>
<td align="right">245</td>
<td align="right">81</td>
<td align="right">15</td>
<td align="right">146</td>
<td align="right">113</td>
<td align="right">388</td>
<td align="right">9</td>
<td align="right">70</td>
<td align="right">69</td>
<td align="right">38</td>
<td align="right">21</td>
<td align="right">18</td>
<td align="right">34</td>
<td align="right">31</td>
<td align="right">25</td>
</tr>
<tr class="odd">
<td align="left">青浦区</td>
<td align="right">384</td>
<td align="right">314</td>
<td align="right">232</td>
<td align="right">87</td>
<td align="right">57</td>
<td align="right">95</td>
<td align="right">77</td>
<td align="right">87</td>
<td align="right">231</td>
<td align="right">13</td>
<td align="right">43</td>
<td align="right">22</td>
<td align="right">13</td>
<td align="right">20</td>
<td align="right">4</td>
<td align="right">10</td>
<td align="right">5</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="left">静安区</td>
<td align="right">302</td>
<td align="right">50</td>
<td align="right">338</td>
<td align="right">189</td>
<td align="right">104</td>
<td align="right">164</td>
<td align="right">102</td>
<td align="right">175</td>
<td align="right">324</td>
<td align="right">2</td>
<td align="right">70</td>
<td align="right">108</td>
<td align="right">70</td>
<td align="right">28</td>
<td align="right">32</td>
<td align="right">48</td>
<td align="right">44</td>
<td align="right">15</td>
</tr>
<tr class="odd">
<td align="left">长宁区</td>
<td align="right">84</td>
<td align="right">33</td>
<td align="right">104</td>
<td align="right">37</td>
<td align="right">115</td>
<td align="right">256</td>
<td align="right">128</td>
<td align="right">30</td>
<td align="right">100</td>
<td align="right">4</td>
<td align="right">45</td>
<td align="right">29</td>
<td align="right">59</td>
<td align="right">19</td>
<td align="right">1</td>
<td align="right">11</td>
<td align="right">26</td>
<td align="right">12</td>
</tr>
<tr class="even">
<td align="left">崇明区</td>
<td align="right">79</td>
<td align="right">47</td>
<td align="right">165</td>
<td align="right">84</td>
<td align="right">67</td>
<td align="right">44</td>
<td align="right">193</td>
<td align="right">55</td>
<td align="right">113</td>
<td align="right">41</td>
<td align="right">236</td>
<td align="right">27</td>
<td align="right">82</td>
<td align="right">19</td>
<td align="right">NA</td>
<td align="right">54</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">奉贤区</td>
<td align="right">144</td>
<td align="right">64</td>
<td align="right">119</td>
<td align="right">161</td>
<td align="right">115</td>
<td align="right">183</td>
<td align="right">130</td>
<td align="right">96</td>
<td align="right">157</td>
<td align="right">NA</td>
<td align="right">45</td>
<td align="right">84</td>
<td align="right">24</td>
<td align="right">8</td>
<td align="right">13</td>
<td align="right">12</td>
<td align="right">22</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="left">金山区</td>
<td align="right">77</td>
<td align="right">52</td>
<td align="right">103</td>
<td align="right">49</td>
<td align="right">19</td>
<td align="right">42</td>
<td align="right">33</td>
<td align="right">26</td>
<td align="right">60</td>
<td align="right">NA</td>
<td align="right">13</td>
<td align="right">4</td>
<td align="right">12</td>
<td align="right">4</td>
<td align="right">11</td>
<td align="right">5</td>
<td align="right">NA</td>
<td align="right">3</td>
</tr>
</tbody>
</table>
<p>画个玫瑰图看看，其实这个图并并能很好反应数据特征。</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-13-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>感觉还不如单纯的条图清晰</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-14-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="发现途径数据获取" class="section level2" number="2.7">
<h2><span class="header-section-number">2.7</span> 发现途径数据获取</h2>
<p>获取数据信息如下</p>
<table>
<colgroup>
<col width="10%" />
<col width="6%" />
<col width="6%" />
<col width="9%" />
<col width="9%" />
<col width="9%" />
<col width="9%" />
<col width="9%" />
<col width="8%" />
<col width="11%" />
<col width="11%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">rep_date</th>
<th align="right">case_c</th>
<th align="right">case_u</th>
<th align="right">case_c_zh</th>
<th align="right">case_c_gk</th>
<th align="right">case_u_gk</th>
<th align="right">case_c_fx</th>
<th align="right">case_u_fx</th>
<th align="right">case_all</th>
<th align="right">case_all_gk</th>
<th align="right">case_all_fx</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2022-04-05</td>
<td align="right">311</td>
<td align="right">16766</td>
<td align="right">40</td>
<td align="right">4</td>
<td align="right">16256</td>
<td align="right">271</td>
<td align="right">510</td>
<td align="right">17077</td>
<td align="right">16260</td>
<td align="right">817</td>
</tr>
<tr class="even">
<td align="left">2022-04-04</td>
<td align="right">268</td>
<td align="right">13086</td>
<td align="right">4</td>
<td align="right">14</td>
<td align="right">12592</td>
<td align="right">264</td>
<td align="right">494</td>
<td align="right">13354</td>
<td align="right">12606</td>
<td align="right">748</td>
</tr>
<tr class="odd">
<td align="left">2022-04-03</td>
<td align="right">425</td>
<td align="right">8581</td>
<td align="right">71</td>
<td align="right">7</td>
<td align="right">7920</td>
<td align="right">354</td>
<td align="right">661</td>
<td align="right">9006</td>
<td align="right">7927</td>
<td align="right">1079</td>
</tr>
<tr class="even">
<td align="left">2022-04-02</td>
<td align="right">438</td>
<td align="right">7788</td>
<td align="right">73</td>
<td align="right">16</td>
<td align="right">6773</td>
<td align="right">365</td>
<td align="right">1015</td>
<td align="right">8226</td>
<td align="right">6789</td>
<td align="right">1437</td>
</tr>
<tr class="odd">
<td align="left">2022-04-01</td>
<td align="right">260</td>
<td align="right">6051</td>
<td align="right">2</td>
<td align="right">8</td>
<td align="right">5402</td>
<td align="right">258</td>
<td align="right">649</td>
<td align="right">6311</td>
<td align="right">5410</td>
<td align="right">901</td>
</tr>
<tr class="even">
<td align="left">2022-03-31</td>
<td align="right">358</td>
<td align="right">4144</td>
<td align="right">20</td>
<td align="right">8</td>
<td align="right">3710</td>
<td align="right">338</td>
<td align="right">434</td>
<td align="right">4502</td>
<td align="right">3718</td>
<td align="right">784</td>
</tr>
</tbody>
</table>
</div>
<div id="时间分布" class="section level2" number="2.8">
<h2><span class="header-section-number">2.8</span> 时间分布</h2>
<p>首先看看的大体趋势，从3月13日起，随着时间感染者数量几乎是成指数增加。但是从风险人群（红线）中检出感染者数量似乎有下降的迹象。
<img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-17-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="人群分布" class="section level2" number="2.9">
<h2><span class="header-section-number">2.9</span> 人群分布</h2>
<p>再看看每天感染者发现途径的变化情况。红色代表每天从风险人群中发现感染者，蓝色代表从管控人群。可见从风险人群中发现感染者的比例大体趋势是逐渐减少的。这种情况视乎是一个好的征兆。但同时需要考虑随着防控政策的变化，对两类人群的定义是否也随之变化？
<img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-18-1.png" width="672" style="display: block; margin: auto;" />
再单独看看风险人群中检出感染者的情况，从了4月3日，4月4日连续两天下降，且看起来几乎是呈直线下降，这是一个好兆头。预示着，随着大规模核酸检测工作的全面铺开，从社会面发现感染者数量的增长势头将会慢慢遏制。</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-19-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="简单总结" class="section level1" number="3">
<h1><span class="header-section-number">3</span> 简单总结</h1>
<p>从上面的简单分析可得知，上海市境外输入感染者数量，从去年2月20日左右开始上升，增加的幅度从平均12例左右，到2月24左右达到85例左右。确实存在一个数量快速增加的阶段，之后过了大概一周的时间上海本地感染者开始快速上升，我们不得不猜测这二者之间可能存在某种联系。最后一张图添加了平滑曲线，做一个大致的预测。从图可见上海这一次疫情新增病人数量仍未到达所谓的“拐点”<del>没爬错数据</del>。随着检测人数的增加，防控措施的进一步加码和落实，相信这一波疫情会逐渐得到控制。</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-20-1.png" width="672" style="display: block; margin: auto;" />
## 预测</p>
<p>建立线性回归模型, 4月7日，预测16912
<img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-21-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
