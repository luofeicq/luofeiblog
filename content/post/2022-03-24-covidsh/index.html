---
title: R爬上海疫情数据简单可视化分析(4月5日更新)
author: Luo Fei
date: '2022-03-24'
slug: covidsh
categories:
  - 中文
tags:
  - Tec
  - R
output:
    blogdown::html_page:
        number_sections: false 
math: true
showToc: true
TocOpen: false
toc-title: "目录"
draft: false
hidemeta: false
comments: false
description: "无责任猜测。"
canonicalURL: ""
disableShare: false
hideSummary: false
searchHidden: false
ShowReadingTime: false
ShowBreadCrumbs: true
ShowPostNavLinks: true
cover:
    image: "" # image path/url
    alt: "<alt text>" # alt text
    caption: "<text>" # display caption under cover
    relative: false # when using page bundles set this to true
    hidden: true # only hide on current single page    
---



<p>今天本地的疫情终于没有增加，抽了点时间关注其他地区的疫情形势。看官方通报的数据，对曾经的模范城市的疫情有兴趣，决定来简单看看。</p>
<div id="数据获取" class="section level1">
<h1>数据获取</h1>
<div id="数据来源" class="section level2">
<h2>数据来源</h2>
<p>要获取准确的数据，当然是上官方网站。打开上海市卫健委的官网(<a href="https://wsjkw.sh.gov.cn/xwfb/index.html" class="uri">https://wsjkw.sh.gov.cn/xwfb/index.html</a>)，疫情数据公告都在“新闻发布”栏目中，再仔细一看，疫情信息的标题中就包含了所有新增、确诊数据。真是太方便了。新闻页面也是连续的以<code>_[num]</code>为页码的编号，这种页面爬起来不要太省事。</p>
</div>
<div id="r包" class="section level2">
<h2>R包</h2>
<p>首先加载需要用到的包，主要使用<code>rvest</code>包获取静态网页信息，谷歌浏览器<code>selectorgadget</code>插件获取需要信息的节点，<code>tidyverse</code>整理数据，绘图，<code>lubridate</code>包处理日期变量。</p>
<pre class="r"><code>library(rvest)
library(tidyverse)
library(lubridate)
library(readxl)
library(openxlsx)
library(ggThemeAssist)</code></pre>
</div>
</div>
<div id="重点关注3月数据" class="section level1">
<h1>重点关注3月数据</h1>
<p>重新爬了一下按地区分布的,代码如下：</p>
<pre class="r"><code>##设置网址
url_all &lt;- paste0(&quot;https://wsjkw.sh.gov.cn/xwfb/index_&quot;,c(2:20),&quot;.html&quot;)
url_all &lt;- c(&quot;https://wsjkw.sh.gov.cn/xwfb/index.html&quot;, url_all)
##自定义爬一级网页函数
webfun &lt;- function(url){
pages &lt;- read_html(url)
url2_sh &lt;-  pages  %&gt;%  
  html_nodes(&quot;.list-date a&quot;) %&gt;% 
  html_attr(&quot;href&quot;) # 次级链接地址
title_sh &lt;- pages %&gt;% 
  html_nodes(&quot;.list-date a&quot;) %&gt;% 
  html_attr(&quot;title&quot;) # 标题
date_sh &lt;- pages %&gt;% 
  html_node(&quot;.time&quot;) %&gt;% 
  html_text() # 日期
data.frame( Date = date_sh,  Title = title_sh, Url = url2_sh) # 组合数据框
}
## 爬取1-20页内容
pages_1 &lt;- map_df(url_all, webfun)
# 根据关键字段“居住信息” 筛选出需要的标题和链接
url_2 &lt;-  pages_1 %&gt;% dplyr::filter(str_detect(Title, &quot;居住地信息&quot;)) %&gt;% mutate(
  url_2 = paste0(&quot;https://wsjkw.sh.gov.cn/&quot;, Url) ) %&gt;% select(url_2) %&gt;% unlist()#组合成所需的所有次级链接地址

# 设置爬取次级网页关键内容的函数
webfun2 &lt;- function(url){
test &lt;-  read_html(url) %&gt;% html_nodes(&quot;p&quot;) %&gt;% html_text() %&gt;% tibble()#获取次级网页所有文本信息
colnames(test) &lt;- &quot;Text&quot; # 设置列名
test %&gt;% 
  dplyr::filter(str_detect(Text, &quot;分别居住&quot;)) %&gt;% # 筛选出含有大区病例信息的段落
  separate(Text, c(&quot;Date&quot;, &quot;col1&quot;, &quot;col2&quot;), sep = &quot;，|、&quot;) %&gt;% # 根据逗号和分号拆分列
  mutate(
    Date_rep = as.Date.character(Date, &quot;%Y年%m月%d日&quot;),# 转换日期类型
    Local = str_extract(col1, &quot;...&quot;), # 提取3字符的地区名
    case_conf = str_extract(col1, &quot;[0-9]+&quot;) %&gt;% as.numeric(), #提取确诊病例数
    case_none = str_extract(col2, &quot;[0-9]+&quot;) %&gt;% as.numeric() # 提取无症状数
  ) %&gt;% select(Date_rep, Local, case_conf, case_none) # 列重新排序
}

final_df &lt;- map_df(url_2, webfun2)# 获取次级链接信息
final_df &lt;- final_df %&gt;%  dplyr::filter(!is.na(Date_rep))  # 筛选出需要的行
final_df[is.na(final_df)] &lt;- 0 # 替换缺失值为0
# 补充完整的区名
final_df &lt;- final_df %&gt;% mutate(
  case_sum = case_conf + case_none,
  Local = case_when(Local == &quot;浦东新&quot; ~ &quot;浦东新区&quot;,
                    Local == &quot;青浦新&quot; ~ &quot;青浦区&quot;,
                    Local == &quot;奉贤无&quot; ~ &quot;奉贤区&quot;,
                    TRUE ~ Local)
)
final_df &lt;-  final_df %&gt;% distinct() # 剔重
write.xlsx(final_df, (&quot;data/shcovid.xlsx&quot;)) # 写出到EXCEL文件</code></pre>
<p>数据爬出来如下表（前20行）：</p>
<table>
<thead>
<tr class="header">
<th align="left">Date_rep</th>
<th align="left">Local</th>
<th align="right">case_conf</th>
<th align="right">case_none</th>
<th align="right">case_sum</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2022-04-04</td>
<td align="left">浦东新区</td>
<td align="right">205</td>
<td align="right">6866</td>
<td align="right">7071</td>
</tr>
<tr class="even">
<td align="left">2022-04-04</td>
<td align="left">黄浦区</td>
<td align="right">8</td>
<td align="right">962</td>
<td align="right">970</td>
</tr>
<tr class="odd">
<td align="left">2022-04-04</td>
<td align="left">静安区</td>
<td align="right">1</td>
<td align="right">49</td>
<td align="right">50</td>
</tr>
<tr class="even">
<td align="left">2022-04-04</td>
<td align="left">徐汇区</td>
<td align="right">8</td>
<td align="right">1221</td>
<td align="right">1229</td>
</tr>
<tr class="odd">
<td align="left">2022-04-04</td>
<td align="left">长宁区</td>
<td align="right">1</td>
<td align="right">32</td>
<td align="right">33</td>
</tr>
<tr class="even">
<td align="left">2022-04-04</td>
<td align="left">普陀区</td>
<td align="right">4</td>
<td align="right">250</td>
<td align="right">254</td>
</tr>
</tbody>
</table>
<p>画个玫瑰图看看，其实这个图并并能很好反应数据特征。</p>
<pre class="r"><code>windowsFonts(A = windowsFont(&quot;微软雅黑&quot;)) # 设置字体

final_df %&gt;% ggplot(aes(x = factor(Date_rep), y = case_sum)) +
  geom_col(aes(fill = Local), width = 1.03) +
  coord_polar(theta = &quot;x&quot;, start = 0, direction = 1) +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(), 
        axis.title = element_blank(),
        legend.position = c(0.9,0.5),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 5),
        text = element_text(family = &quot;A&quot;)
        )+ geom_text(data = final_df %&gt;% dplyr::filter(Local == &quot;浦东新区&quot;), aes(label = Date_rep ),
                                  nudge_y = 3000,
                                  size = 2, 
                                  ) +
  guides(fill = guide_legend(ncol = 2) ) +
  theme(plot.margin = unit(rep(0.5,4), &quot;mm&quot;),
        legend.key.size = unit(3,&quot;mm&quot;),
        aspect.ratio = 1) +
  scale_y_continuous(expand = c(0,0), limits = c(-500,15000)) </code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-5-1.png" width="672" style="display: block; margin: auto;" /></p>
<div id="主页信息获取" class="section level2">
<h2>主页信息获取</h2>
<p>使用<code>selectorgadget</code>在网页上找到需要的变量“时间”和“标题”，对应的node分别是<code>.time</code>和<code>.list-data a</code>，使用<code>rvest</code>抓取后，转为文本存储在列表中。</p>
<pre class="r"><code>## 设置url
url &lt;- &quot;https://wsjkw.sh.gov.cn/xwfb/index.html&quot;
## 获取首页信息
content &lt;- read_html(url)
reportdate &lt;- content %&gt;%  html_nodes(&quot;.time&quot;) %&gt;% html_text() %&gt;% as.Date.character()
title &lt;-  content %&gt;% html_nodes(&quot;.list-date a&quot;) %&gt;% html_text() 
basedata &lt;- tibble(reportdate = reportdate, title = title)</code></pre>
</div>
<div id="爬取所有数据" class="section level2">
<h2>爬取所有数据</h2>
<p>上海的疫情变化主要从3月开始，但为了查看之前的变化，是否输入病例压力增大导致本次疫情，因此爬取了2到200页到的数据。使用<code>for</code>循环，<code>rbind</code>组合成基础数据。</p>
<pre class="r"><code>##使用循环爬取2到200也网页信息

for (i in 2:200) {  
  url = paste0(&quot;https://wsjkw.sh.gov.cn/xwfb/index_&quot;, i, &quot;.html&quot;)
  content &lt;- read_html(url)
  reportdate &lt;- content %&gt;%  html_nodes(&quot;.time&quot;) %&gt;% html_text() %&gt;% as.Date.character()
  title &lt;-  content %&gt;% html_nodes(&quot;.list-date a&quot;) %&gt;% html_text() 
  basedata &lt;- basedata %&gt;% rbind(  tibble(reportdate = reportdate, title = title))
}
## 写出数据
write.csv(basedata,&quot;data/basedata.csv&quot;)</code></pre>
</div>
<div id="数据清洗" class="section level2">
<h2>数据清洗</h2>
<p>这一步比较麻烦的是对标题中日期字符的整理。使用<code>str_extract_all</code>命令后提取的日期，变成了列表。再合并为向量形势的日期格式数据时出了点麻烦。最后使用了笨办法<code>for</code>循环<code>unlist</code>后再<code>paste0</code>合并。其实直接用标题前的日期-1没什么大的误差，主要是在跟自己较劲搞得这么麻烦。</p>
</div>
</div>
<div id="好了开始分析吧" class="section level1">
<h1>好了，开始分析吧</h1>
<div id="先画个简单的图看看大趋势" class="section level2">
<h2>先画个简单的图看看大趋势</h2>
<p>以报告感染者类型为颜色看，从20年1月到21年12月期间，上海的感染人数几乎在处于一个长期稳定的状态，从2022年3月开始呈直升飞机式的增长。奇怪的是中间咋有个空白区，没有数据。查看原始网页，发现网站从2021年11月6日-2022年1月1日没有更新数据。这是一个奇怪的现象。不过没关系，这不影响我们后面的分析，<del>这对原因分析有很大关系</del>。</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-9-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="输入感染者的趋势" class="section level2">
<h2>输入感染者的趋势</h2>
<p>对上海这波疫情有个合理的猜测是，1月初上海接纳大量某地的航班的，导致上海市输入疫情压力陡增，再加上Omicron变异株超强传播能力，双重压力下导致这个模范城市失守。好吧，我们来看看是否能验证输入压力陡增这个猜测。从图上看好像跟上图颇像，鉴于确诊和无症状都属与感染这，下一步我们把本地和输入的感染者的合计数的变化可视化看看。</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-10-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="感染者总数" class="section level2">
<h2>感染者总数</h2>
<p>先用二者做个散点图看看,如图，完全看不出啥关系啊。。。。输入感染者较多的时候，反而本地感染处于低水平。这个图像，线性回归暂时也不考虑。我们还是从感染者数量和时间的关系看看。</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-11-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>画出来如下，大致能看从1月到3月二者都在上升，但到了3月后，二者分道扬镳了。
<img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-12-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="年1到三月" class="section level2">
<h2>2022年1到三月</h2>
<p>我们把时间尺度拉大到2月中旬到3月看看。放大后（下图1）可以看到从2月10日起到2月21日之间，二者几乎是呈线性相关，到2月22日，输入感染人数开始上升，此时上海本地感染数量仍然无幅度的改变，处于平稳状态，此时输入感染者数量是大于本地感染。</p>
<p>为了更仔细看清楚变化情况，我们将y轴的数量调整至0-100例（下图2），这时候能清楚看到每天的变化。3月6日左右，二者数量出现了反转，本地感染者数量快速上升，并大幅度超过输入感染者。</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-13-1.png" width="672" style="display: block; margin: auto;" /><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-13-2.png" width="672" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="简单总结" class="section level1">
<h1>简单总结</h1>
<p>从上面的简单分析可得知，上海市境外输入感染者数量，从去年2月20日左右开始上升，增加的幅度从平均12例左右，到2月24左右达到85例左右。确实存在一个数量快速增加的阶段，之后过了大概一周的时间上海本地感染者开始快速上升，我们不得不猜测这二者之间可能存在某种联系。最后一张图添加了平滑曲线，做一个大致的预测。从图可见上海这一次疫情新增病人数量仍未到达所谓的“拐点”<del>没爬错数据</del>。随着检测人数的增加，防控措施的进一步加码和落实，相信这一波疫情会逐渐得到控制。</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-14-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
